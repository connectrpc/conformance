name: Bidi Cancellation
relevantHttpVersions:
  - HTTP_VERSION_2
  - HTTP_VERSION_3
# TODO - Need to fix the timeout issues with wrapping context deadline. Right now
# these tests break for gRPC until that issue is addressed
relevantProtocols:
  - PROTOCOL_CONNECT
  - PROTOCOL_GRPC_WEB
testCases:
- request:
    testName: bidi full duplex cancel after zero responses
    service: connectrpc.conformance.v1.ConformanceService
    method: BidiStream
    streamType: STREAM_TYPE_FULL_DUPLEX_BIDI_STREAM
    cancel:
      afterNumResponses: 0
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      responseDefinition:
        responseData:
          - "dGVzdCByZXNwb25zZQ=="
          - "dGVzdCByZXNwb25zZQ=="
      fullDuplex: true
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      requestData: "dGVzdCByZXNwb25zZQ=="
  # Override
  expectedResponse:
    error:
      code: 1
testCases:
- request:
    testName: bidi full duplex cancel after responses
    service: connectrpc.conformance.v1.ConformanceService
    method: BidiStream
    streamType: STREAM_TYPE_FULL_DUPLEX_BIDI_STREAM
    cancel:
      afterNumResponses: 1
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      responseDefinition:
        responseData:
          - "dGVzdCByZXNwb25zZQ=="
          - "dGVzdCByZXNwb25zZQ=="
      fullDuplex: true
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      requestData: "dGVzdCByZXNwb25zZQ=="
  # Override
  expectedResponse:
    payloads:
      - data: "dGVzdCByZXNwb25zZQ=="
        requestInfo:
          requests:
            - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
              responseDefinition:
                responseData:
                  - "dGVzdCByZXNwb25zZQ=="
                  - "dGVzdCByZXNwb25zZQ=="
              fullDuplex: true
    error:
      code: 1
# TODO - This is returning a Code Unknown (prob related to context bugs?)
# TODO - also is 2 responses correct? I believe so.
# - request:
#     testName: bidi full duplex cancel before close send
#     service: connectrpc.conformance.v1.ConformanceService
#     method: BidiStream
#     streamType: STREAM_TYPE_FULL_DUPLEX_BIDI_STREAM
#     cancel:
#       beforeCloseSend:
#     requestMessages:
#     - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#       responseDefinition:
#         responseData:
#           - "dGVzdCByZXNwb25zZQ=="
#           - "dGVzdCByZXNwb25zZQ=="
#       fullDuplex: true
#     - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#       requestData: "dGVzdCByZXNwb25zZQ=="
#   # Override
#   expectedResponse:
#     payloads:
#       - data: "dGVzdCByZXNwb25zZQ=="
#         requestInfo:
#           requests:
#             - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#               responseDefinition:
#                 responseData:
#                   - "dGVzdCByZXNwb25zZQ=="
#                   - "dGVzdCByZXNwb25zZQ=="
#               fullDuplex: true
#       - data: "dGVzdCByZXNwb25zZQ=="
#         requestInfo:
#           requests:
#             - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#               requestData: "dGVzdCByZXNwb25zZQ=="
#     error:
#       code: 1
# TODO - This is returning a Code Unknown (prob related to context bugs?)
# - request:
#     testName: bidi full duplex cancel after close send
#     service: connectrpc.conformance.v1.ConformanceService
#     method: BidiStream
#     streamType: STREAM_TYPE_FULL_DUPLEX_BIDI_STREAM
#     cancel:
#       afterCloseSendMs: 100
#     requestMessages:
#     - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#       responseDefinition:
#         responseDelayMs: 250
#         responseData:
#           - "dGVzdCByZXNwb25zZQ=="
#           - "dGVzdCByZXNwb25zZQ=="
#       fullDuplex: true
#     - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#       requestData: "dGVzdCByZXNwb25zZQ=="
#   # Override
#   expectedResponse:
#     payloads:
#       - data: "dGVzdCByZXNwb25zZQ=="
#         requestInfo:
#           requests:
#             - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#               responseDefinition:
#                 responseDelayMs: 250
#                 responseData:
#                   - "dGVzdCByZXNwb25zZQ=="
#                   - "dGVzdCByZXNwb25zZQ=="
#               fullDuplex: true
#       - data: "dGVzdCByZXNwb25zZQ=="
#         requestInfo:
#           requests:
#             - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#               requestData: "dGVzdCByZXNwb25zZQ=="
#     error:
#       code: 1
- request:
    testName: bidi half duplex cancel after zero responses
    service: connectrpc.conformance.v1.ConformanceService
    method: BidiStream
    streamType: STREAM_TYPE_HALF_DUPLEX_BIDI_STREAM
    cancel:
      afterNumResponses: 0
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      responseDefinition:
        responseData:
          - "dGVzdCByZXNwb25zZQ=="
          - "dGVzdCByZXNwb25zZQ=="
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      requestData: "dGVzdCByZXNwb25zZQ=="
  # Override
  expectedResponse:
    error:
      code: 1
- request:
    testName: bidi half duplex cancel after responses
    service: connectrpc.conformance.v1.ConformanceService
    method: BidiStream
    streamType: STREAM_TYPE_HALF_DUPLEX_BIDI_STREAM
    cancel:
      afterNumResponses: 1
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      responseDefinition:
        responseData:
          - "dGVzdCByZXNwb25zZQ=="
          - "dGVzdCByZXNwb25zZQ=="
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      requestData: "dGVzdCByZXNwb25zZQ=="
  # Override
  expectedResponse:
    payloads:
      - data: "dGVzdCByZXNwb25zZQ=="
        requestInfo:
          requests:
            - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
              responseDefinition:
                responseData:
                  - "dGVzdCByZXNwb25zZQ=="
                  - "dGVzdCByZXNwb25zZQ=="
            - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
              requestData: "dGVzdCByZXNwb25zZQ=="
    error:
      code: 1
# TODO - This is returning a Code Unknown (prob related to context bugs?)
# - request:
#     testName: bidi half duplex cancel before close send
#     service: connectrpc.conformance.v1.ConformanceService
#     method: BidiStream
#     streamType: STREAM_TYPE_HALF_DUPLEX_BIDI_STREAM
#     cancel:
#       beforeCloseSend:
#     requestMessages:
#     - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#       responseDefinition:
#         responseData:
#           - "dGVzdCByZXNwb25zZQ=="
#           - "dGVzdCByZXNwb25zZQ=="
#     - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#       requestData: "dGVzdCByZXNwb25zZQ=="
#   # Override
#   expectedResponse:
#     error:
#       code: 1
# TODO - This is returning a Code Unknown (prob related to context bugs?)
# - request:
#     testName: bidi half duplex cancel after close send
#     service: connectrpc.conformance.v1.ConformanceService
#     method: BidiStream
#     streamType: STREAM_TYPE_HALF_DUPLEX_BIDI_STREAM
#     cancel:
#       afterCloseSendMs: 100
#     requestMessages:
#     - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#       responseDefinition:
#         responseDelayMs: 250
#         responseData:
#           - "dGVzdCByZXNwb25zZQ=="
#           - "dGVzdCByZXNwb25zZQ=="
#     - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
#       requestData: "dGVzdCByZXNwb25zZQ=="
#   # Override
#   expectedResponse:
#     error:
#       code: 1
