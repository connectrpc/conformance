name: Errors
# This suite contains various tests for error handling. In addition to testing
# scenarios per RPC type, it tests that all Connect error codes are able to be
# returned for both unary responses and streaming responses, since errors are
# represented differently on the wire for each.
testCases:
# Unary Tests -----------------------------------------------------------------
- request:
    testName: unary/canceled
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 1
          message: "canceled"
- request:
    testName: unary/unknown
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 2
          message: "unknown"
- request:
    testName: unary/invalid-argument
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 3
          message: "invalid argument"
- request:
    testName: unary/deadline-exceeded
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 4
          message: "deadline exceeded"
- request:
    testName: unary/not-found
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 5
          message: "not found"
- request:
    testName: unary/already-exists
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 6
          message: "already exists"
- request:
    testName: unary/permission-denied
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 7
          message: "permission denied"
- request:
    testName: unary/resource-exhausted
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 8
          message: "resource exhausted"
- request:
    testName: unary/failed-precondition
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 9
          message: "failed precondition"
- request:
    testName: unary/aborted
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 10
          message: "aborted"
- request:
    testName: unary/out-of-range
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 11
          message: "out of range"
- request:
    testName: unary/unimplemented
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 12
          message: "unimplemented"
- request:
    testName: unary/internal
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 13
          message: "internal"
- request:
    testName: unary/unavailable
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 14
          message: "unavailable"
- request:
    testName: unary/data-loss
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 15
          message: "data loss"
- request:
    testName: unary/unauthenticated
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 16
          message: "unauthenticated"
- request:
    testName: unary/unicode-error-message
    service: connectrpc.conformance.v1.ConformanceService
    method: Unary
    streamType: STREAM_TYPE_UNARY
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
      responseDefinition:
        error:
          code: 13
          message: "\ntest with whitespace\r\nand Unicode BMP â˜º and non-BMP ðŸ˜ˆ\n"
# Server Stream Tests ---------------------------------------------------------
- request:
    testName: server-stream/canceled
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 1
          message: "canceled"
- request:
    testName: server-stream/unknown
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 2
          message: "unknown"
- request:
    testName: server-stream/invalid-argument
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 3
          message: "invalid argument"
- request:
    testName: server-stream/deadline-exceeded
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 4
          message: "deadline exceeded"
- request:
    testName: server-stream/not-found
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 5
          message: "not found"
- request:
    testName: server-stream/already-exists
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 6
          message: "already exists"
- request:
    testName: server-stream/permission-denied
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 7
          message: "permission denied"
- request:
    testName: server-stream/resource-exhausted
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 8
          message: "resource exhausted"
- request:
    testName: server-stream/failed-precondition
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 9
          message: "failed precondition"
- request:
    testName: server-stream/aborted
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 10
          message: "aborted"
- request:
    testName: server-stream/out-of-range
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 11
          message: "out of range"
- request:
    testName: server-stream/unimplemented
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 12
          message: "unimplemented"
- request:
    testName: server-stream/internal
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 13
          message: "internal"
- request:
    testName: server-stream/unavailable
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 14
          message: "unavailable"
- request:
    testName: server-stream/data-loss
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 15
          message: "data loss"
- request:
    testName: server-stream/unauthenticated
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        error:
          code: 16
          message: "unauthenticated"
- request:
    testName: server-stream/error-with-responses
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestHeaders:
    - name: X-Conformance-Test
      value: ["Value1","Value2"]
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        responseHeaders:
        - name: x-custom-header
          value: ["foo"]
        responseData:
          - "dGVzdCByZXNwb25zZQ=="
          - "dGVzdCByZXNwb25zZQ=="
        error:
          code: 13
          message: "server stream failed"
        responseTrailers:
        - name: x-custom-trailer
          value: ["bing"]
- request:
    testName: server-stream/error-with-no-responses
    service: connectrpc.conformance.v1.ConformanceService
    method: ServerStream
    streamType: STREAM_TYPE_SERVER_STREAM
    requestHeaders:
    - name: X-Conformance-Test
      value: ["Value1","Value2"]
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
      responseDefinition:
        responseHeaders:
        - name: x-custom-header
          value: ["foo"]
        error:
          code: 13
          message: "server stream failed"
        responseTrailers:
        - name: x-custom-trailer
          value: ["bing"]
# Client Stream Tests -----------------------------------------------------------
- request:
    testName: client-stream/error-one-request
    service: connectrpc.conformance.v1.ConformanceService
    method: ClientStream
    streamType: STREAM_TYPE_CLIENT_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
      responseDefinition:
        error:
          code: 13
          message: "client stream failed"
- request:
    testName: client-stream/error-multiple-requests
    service: connectrpc.conformance.v1.ConformanceService
    method: ClientStream
    streamType: STREAM_TYPE_CLIENT_STREAM
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
      responseDefinition:
        error:
          code: 13
          message: "client stream failed"
    - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
      requestData: "dGVzdCByZXNwb25zZQ=="
# Bidi Stream Tests -----------------------------------------------------------
- request:
    testName: bidi-stream/full-duplex/error-with-responses
    service: connectrpc.conformance.v1.ConformanceService
    method: BidiStream
    streamType: STREAM_TYPE_FULL_DUPLEX_BIDI_STREAM
    requestHeaders:
      - name: X-Conformance-Test
        value: ["Value1","Value2"]
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      responseDefinition:
        responseHeaders:
          - name: x-custom-header
            value: ["foo"]
        responseData:
          - "dGVzdCByZXNwb25zZQ=="
          - "dGVzdCByZXNwb25zZQ=="
        error:
          code: 13
          message: "bidi full duplex stream failed"
        responseTrailers:
        - name: x-custom-trailer
          value: ["bing"]
      fullDuplex: true
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      requestData: "dGVzdCByZXNwb25zZQ=="
- request:
    testName: bidi-stream/full-duplex/error-no-responses
    service: connectrpc.conformance.v1.ConformanceService
    method: BidiStream
    streamType: STREAM_TYPE_FULL_DUPLEX_BIDI_STREAM
    requestHeaders:
      - name: X-Conformance-Test
        value: ["Value1","Value2"]
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      responseDefinition:
        responseHeaders:
          - name: x-custom-header
            value: ["foo"]
        error:
          code: 13
          message: "bidi full duplex stream failed"
        responseTrailers:
        - name: x-custom-trailer
          value: ["bing"]
      fullDuplex: true
- request:
    testName: bidi-stream/half-duplex/error-with-responses
    service: connectrpc.conformance.v1.ConformanceService
    method: BidiStream
    streamType: STREAM_TYPE_HALF_DUPLEX_BIDI_STREAM
    requestHeaders:
      - name: X-Conformance-Test
        value: ["Value1","Value2"]
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      responseDefinition:
        responseHeaders:
          - name: x-custom-header
            value: ["foo"]
        responseData:
          - "dGVzdCByZXNwb25zZQ=="
          - "dGVzdCByZXNwb25zZQ=="
        error:
          code: 13
          message: "bidi half duplex stream failed"
        responseTrailers:
        - name: x-custom-trailer
          value: ["bing"]
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      requestData: "dGVzdCByZXNwb25zZQ=="
- request:
    testName: bidi-stream/half-duplex/error-with-no-responses
    service: connectrpc.conformance.v1.ConformanceService
    method: BidiStream
    streamType: STREAM_TYPE_HALF_DUPLEX_BIDI_STREAM
    requestHeaders:
      - name: X-Conformance-Test
        value: ["Value1","Value2"]
    requestMessages:
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      responseDefinition:
        responseHeaders:
          - name: x-custom-header
            value: ["foo"]
        error:
          code: 13
          message: "bidi half duplex stream failed"
        responseTrailers:
        - name: x-custom-trailer
          value: ["bing"]
    - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
      requestData: "dGVzdCByZXNwb25zZQ=="
