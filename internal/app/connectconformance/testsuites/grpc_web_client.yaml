name: gRPC Web Client
mode: TEST_MODE_CLIENT
relevantProtocols:
  - PROTOCOL_GRPC_WEB
relevantCodecs:
  - CODEC_PROTO
relevantCompressions:
  - COMPRESSION_IDENTITY
# These tests verify that a gRPC-Web client can handle trailers in the body with
# no response, trailers-only responses (trailers in headers), and trailers with
# different cases (in addition to the "standard" all lower-case).
testCases:

# Trailers and status are in body (no other response messages)
  - request:
      testName: unary trailers in body
      service: connectrpc.conformance.v1.ConformanceService
      method: Unary
      streamType: STREAM_TYPE_UNARY
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo" ]
              stream:
                items:
                  - flags: 128
                    payload:
                      text: "grpc-status: 9\r\ngrpc-message: error\r\nx-custom-trailer: bing\r\n"
    expectedResponse:
      responseHeaders:
        - name: x-custom-header
          value: [ "foo" ]
      error:
        code: 9
        message: error
      responseTrailers:
        - name: x-custom-trailer
          value: [ "bing" ]
  - request:
      testName: unary trailers in body, mixed case
      service: connectrpc.conformance.v1.ConformanceService
      method: Unary
      streamType: STREAM_TYPE_UNARY
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo" ]
              stream:
                items:
                  - flags: 128
                    payload:
                      text: "Grpc-Status: 9\r\ngRPC-Message: error\r\nx-Custom-Trailer: bing\r\n"
    expectedResponse:
      responseHeaders:
        - name: x-custom-header
          value: [ "foo" ]
      error:
        code: 9
        message: error
      responseTrailers:
        - name: x-custom-trailer
          value: [ "bing" ]
  - request:
      testName: unary trailers in body, duplicates
      service: connectrpc.conformance.v1.ConformanceService
      method: Unary
      streamType: STREAM_TYPE_UNARY
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo", "bar", "baz" ]
              stream:
                items:
                  - flags: 128
                    payload:
                      text: "grpc-status: 9\r\ngrpc-message: error\r\nx-custom-trailer: bing\r\nx-custom-trailer: quuz\r\n"
    expectedResponse:
      responseHeaders:
      - name: x-custom-header
        value: [ "foo", "bar", "baz" ]
      error:
        code: 9
        message: error
      responseTrailers:
      - name: x-custom-trailer
        value: [ "bing", "quuz" ]

  - request:
      testName: server stream trailers in body
      service: connectrpc.conformance.v1.ConformanceService
      method: ServerStream
      streamType: STREAM_TYPE_SERVER_STREAM
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo" ]
              stream:
                items:
                  - flags: 128
                    payload:
                      text: "grpc-status: 9\r\ngrpc-message: error\r\nx-custom-trailer: bing\r\n"
    expectedResponse:
      responseHeaders:
        - name: x-custom-header
          value: [ "foo" ]
      error:
        code: 9
        message: error
      responseTrailers:
        - name: x-custom-trailer
          value: [ "bing" ]
  - request:
      testName: server stream trailers in body, mixed case
      service: connectrpc.conformance.v1.ConformanceService
      method: ServerStream
      streamType: STREAM_TYPE_SERVER_STREAM
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo" ]
              stream:
                items:
                  - flags: 128
                    payload:
                      text: "grpc-status: 9\r\ngRPC-Message: error\r\nx-Custom-Trailer: bing\r\n"
    expectedResponse:
      responseHeaders:
        - name: x-custom-header
          value: [ "foo" ]
      error:
        code: 9
        message: error
      responseTrailers:
        - name: x-custom-trailer
          value: [ "bing" ]
  - request:
      testName: server stream trailers in body, duplicates
      service: connectrpc.conformance.v1.ConformanceService
      method: ServerStream
      streamType: STREAM_TYPE_SERVER_STREAM
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo", "bar", "baz" ]
              stream:
                items:
                  - flags: 128
                    payload:
                      text: "grpc-status: 9\r\ngrpc-message: error\r\nx-custom-trailer: bing\r\nx-custom-trailer: quuz\r\n"
    expectedResponse:
      responseHeaders:
        - name: x-custom-header
          value: [ "foo", "bar", "baz" ]
      error:
        code: 9
        message: error
      responseTrailers:
        - name: x-custom-trailer
          value: [ "bing", "quuz" ]

# Trailers-only responses, where status and trailers are in HTTP headers
  - request:
      testName: unary trailers in headers
      service: connectrpc.conformance.v1.ConformanceService
      method: Unary
      streamType: STREAM_TYPE_UNARY
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo" ]
                - name: x-custom-trailer
                  value: [ "bing" ]
                - name: grpc-status
                  value: [ "9" ]
                - name: grpc-message
                  value: [ "error" ]
    expectedResponse:
      responseHeaders:
        - name: x-custom-header
          value: [ "foo" ]
      error:
        code: 9
        message: error
      responseTrailers:
        - name: x-custom-trailer
          value: [ "bing" ]
  - request:
      testName: unary trailers in headers, duplicates
      service: connectrpc.conformance.v1.ConformanceService
      method: Unary
      streamType: STREAM_TYPE_UNARY
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo", "bar", "baz" ]
                - name: x-custom-trailer
                  value: [ "bing", "quuz" ]
                - name: grpc-status
                  value: [ "9" ]
                - name: grpc-message
                  value: [ "error" ]
    expectedResponse:
      responseHeaders:
        - name: x-custom-header
          value: [ "foo", "bar", "baz" ]
      error:
        code: 9
        message: error
      responseTrailers:
        - name: x-custom-trailer
          value: [ "bing", "quuz" ]

  - request:
      testName: server stream trailers in headers
      service: connectrpc.conformance.v1.ConformanceService
      method: ServerStream
      streamType: STREAM_TYPE_SERVER_STREAM
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo" ]
                - name: x-custom-trailer
                  value: [ "bing" ]
                - name: grpc-status
                  value: [ "9" ]
                - name: grpc-message
                  value: [ "error" ]
    expectedResponse:
      responseHeaders:
        - name: x-custom-header
          value: [ "foo" ]
      error:
        code: 9
        message: error
      responseTrailers:
        - name: x-custom-trailer
          value: [ "bing" ]
  - request:
      testName: server stream trailers in headers, duplicates
      service: connectrpc.conformance.v1.ConformanceService
      method: ServerStream
      streamType: STREAM_TYPE_SERVER_STREAM
      requestMessages:
        - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
          responseDefinition:
            rawResponse:
              status_code: 200
              headers:
                - name: "access-control-allow-origin"
                  value: [ "*" ]
                - name: "access-control-expose-headers"
                  value: [ "*" ]
                - name: content-type
                  value: [ "application/grpc-web" ]
                - name: x-custom-header
                  value: [ "foo", "bar", "baz" ]
                - name: x-custom-trailer
                  value: [ "bing", "quuz" ]
                - name: grpc-status
                  value: [ "9" ]
                - name: grpc-message
                  value: [ "error" ]
    expectedResponse:
      responseHeaders:
        - name: x-custom-header
          value: [ "foo", "bar", "baz" ]
      error:
        code: 9
        message: error
      responseTrailers:
        - name: x-custom-trailer
          value: [ "bing", "quuz" ]
  - request:
      testName: unary/error/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: Unary
      streamType: STREAM_TYPE_UNARY
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
        responseDefinition:
          error:
            code: 3
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      error:
        code: 3
        details: 
          - "@type": type.googleapis.com/connectrpc.conformance.v1.ConformancePayload.RequestInfo
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
                responseDefinition:
                  error:
                    code: 3
  - request:
      testName: unary/success/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: Unary
      streamType: STREAM_TYPE_UNARY
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
        responseDefinition:
          responseData: "dGVzdCByZXNwb25zZQ=="
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      payloads:
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.UnaryRequest
                responseDefinition:
                  responseData: "dGVzdCByZXNwb25zZQ=="
  - request:
      testName: client-stream/error/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: ClientStream
      streamType: STREAM_TYPE_CLIENT_STREAM
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
        responseDefinition:
          error:
            code: 13
            message: "client stream failed"
      - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
        requestData: "dGVzdCByZXNwb25zZQ=="
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      error:
        code: 13
        details: 
          - "@type": type.googleapis.com/connectrpc.conformance.v1.ConformancePayload.RequestInfo
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
                responseDefinition:
                  error:
                    code: 13
                    message: "client stream failed"
              - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
                requestData: "dGVzdCByZXNwb25zZQ=="
  - request:
      testName: client-stream/success/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: ClientStream
      streamType: STREAM_TYPE_CLIENT_STREAM
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
        responseDefinition:
          responseData: "dGVzdCByZXNwb25zZQ=="
      - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
        requestData: "dGVzdCByZXNwb25zZQ=="
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      payloads:
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
                responseDefinition:
                  responseData: "dGVzdCByZXNwb25zZQ=="
              - "@type": type.googleapis.com/connectrpc.conformance.v1.ClientStreamRequest
                requestData: "dGVzdCByZXNwb25zZQ=="
  - request:
      testName: server-stream/success/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: ServerStream
      streamType: STREAM_TYPE_SERVER_STREAM
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
        responseDefinition:
          responseData:
            - "dGVzdCByZXNwb25zZQ=="
            - "dGVzdCByZXNwb25zZQ=="
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      payloads:
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
                responseDefinition:
                  responseData:
                    - "dGVzdCByZXNwb25zZQ=="
                    - "dGVzdCByZXNwb25zZQ=="
        - data: "dGVzdCByZXNwb25zZQ=="
  - request:
      testName: server-stream/error/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: ServerStream
      streamType: STREAM_TYPE_SERVER_STREAM
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
        responseDefinition:
          responseData:
            - "dGVzdCByZXNwb25zZQ=="
            - "dGVzdCByZXNwb25zZQ=="
          error:
            code: 13
            message: "server stream failed"
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      error:
        code: 13
        message: "server stream failed"
      payloads:
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.ServerStreamRequest
                responseDefinition:
                  responseData:
                    - "dGVzdCByZXNwb25zZQ=="
                    - "dGVzdCByZXNwb25zZQ=="
                  error:
                    code: 13
                    message: "server stream failed"
        - data: "dGVzdCByZXNwb25zZQ=="
  - request:
      testName: bidi-full-duplex/success/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: BidiStream
      streamType: STREAM_TYPE_FULL_DUPLEX_BIDI_STREAM
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
        responseDefinition:
          responseData:
            - "dGVzdCByZXNwb25zZQ=="
            - "dGVzdCByZXNwb25zZQ=="
        fullDuplex: true
      - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
        requestData: "dGVzdCByZXNwb25zZQ=="
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      payloads:
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
                responseDefinition:
                  responseData:
                    - "dGVzdCByZXNwb25zZQ=="
                    - "dGVzdCByZXNwb25zZQ=="
                fullDuplex: true
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
                requestData: "dGVzdCByZXNwb25zZQ=="
  - request:
      testName: bidi-full-duplex/error/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: BidiStream
      streamType: STREAM_TYPE_FULL_DUPLEX_BIDI_STREAM
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
        responseDefinition:
          responseData:
            - "dGVzdCByZXNwb25zZQ=="
            - "dGVzdCByZXNwb25zZQ=="
          error:
            code: 13
            message: "bidi half duplex stream failed"
        fullDuplex: true
      - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
        requestData: "dGVzdCByZXNwb25zZQ=="
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      error:
        code: 13
        message: "bidi half duplex stream failed"
      payloads:
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
                responseDefinition:
                  responseData:
                    - "dGVzdCByZXNwb25zZQ=="
                    - "dGVzdCByZXNwb25zZQ=="
                  error:
                    code: 13
                    message: "bidi half duplex stream failed"
                fullDuplex: true
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
                requestData: "dGVzdCByZXNwb25zZQ=="
  - request:
      testName: bidi-half-duplex/success/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: BidiStream
      streamType: STREAM_TYPE_HALF_DUPLEX_BIDI_STREAM
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
        responseDefinition:
          responseData:
            - "dGVzdCByZXNwb25zZQ=="
            - "dGVzdCByZXNwb25zZQ=="
      - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
        requestData: "dGVzdCByZXNwb25zZQ=="
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      payloads:
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
                responseDefinition:
                  responseData:
                    - "dGVzdCByZXNwb25zZQ=="
                    - "dGVzdCByZXNwb25zZQ=="
              - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
                requestData: "dGVzdCByZXNwb25zZQ=="
        - data: "dGVzdCByZXNwb25zZQ=="
  - request:
      testName: bidi-half-duplex/error/has-correct-wire-details
      service: connectrpc.conformance.v1.ConformanceService
      method: BidiStream
      streamType: STREAM_TYPE_HALF_DUPLEX_BIDI_STREAM
      requestMessages:
      - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
        responseDefinition:
          responseData:
            - "dGVzdCByZXNwb25zZQ=="
            - "dGVzdCByZXNwb25zZQ=="
          error:
            code: 13
            message: "bidi half duplex stream failed"
      - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
        requestData: "dGVzdCByZXNwb25zZQ=="
    expectedResponse:
      wireDetails:
        actualStatusCode: 200
        actualHttpTrailers: []
      error:
        code: 13
        message: "bidi half duplex stream failed"
      payloads:
        - data: "dGVzdCByZXNwb25zZQ=="
          requestInfo:
            requests:
              - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
                responseDefinition:
                  responseData:
                    - "dGVzdCByZXNwb25zZQ=="
                    - "dGVzdCByZXNwb25zZQ=="
                  error:
                    code: 13
                    message: "bidi half duplex stream failed"
              - "@type": type.googleapis.com/connectrpc.conformance.v1.BidiStreamRequest
                requestData: "dGVzdCByZXNwb25zZQ=="
        - data: "dGVzdCByZXNwb25zZQ=="
